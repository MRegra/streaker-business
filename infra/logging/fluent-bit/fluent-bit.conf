[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

# Read Docker stdout/stderr JSON logs
[INPUT]
    Name                 tail
    Path                 /var/lib/docker/containers/*/*-json.log
    Tag                  docker.*
    Parser               docker
    Mem_Buf_Limit        50MB
    Skip_Long_Lines      On
    Refresh_Interval     5
    DB                   /fluent-bit/state/docker.db
    DB.Sync              Normal
    Rotate_Wait          5
    # Optional but nice: enable Docker tailing mode explicitly
    Docker_Mode          On
    Docker_Mode_Parser   docker

# Enrich with container metadata from the Docker Engine
# (requires /var/run/docker.sock to be mounted read-only)
[FILTER]
    Name                docker
    Match               docker.*
    Docker_Mode         On
    Merge_Log           On
    Keep_Log            On
    Labels           On

# Keep labels low-cardinality for Loki
[FILTER]
    Name          modify
    Match         docker.*
    Add           job streaker
    # Keep the original name from the docker filter
    # (you can rename if you prefer a shorter label)
    # Rename      container_name container

# Ship to Loki
[OUTPUT]
    Name                loki
    Match               docker.*
    Host                loki
    Port                3100
    # Use stable, low-cardinality labels
    Labels              job=${job}, container=${container_name}, stream=${stream}
    Line_Format         json
    Auto_Kubernetes_Labels Off
    Log_Level           info
